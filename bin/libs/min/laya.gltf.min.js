!function(e,t){"use strict";class r{constructor(){}static init(){if(!r.lookup){r.lookup=new Uint8Array(256);for(var e=0;e<r.chars.length;e++)r.lookup[r.chars.charCodeAt(e)]=e}}static isBase64String(e){return r.reg.test(e)}static encode(e){var t,a=new Uint8Array(e),n=a.length,l="";for(t=0;t<n;t+=3)l+=r.chars[a[t]>>2],l+=r.chars[(3&a[t])<<4|a[t+1]>>4],l+=r.chars[(15&a[t+1])<<2|a[t+2]>>6],l+=r.chars[63&a[t+2]];return n%3==2?l=l.substring(0,l.length-1)+"=":n%3==1&&(l=l.substring(0,l.length-2)+"=="),l}static decode(e){r.init();var t,a,n,l,s,o=.75*e.length,i=e.length,u=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);var c=new ArrayBuffer(o),d=new Uint8Array(c);for(t=0;t<i;t+=4)a=r.lookup[e.charCodeAt(t)],n=r.lookup[e.charCodeAt(t+1)],l=r.lookup[e.charCodeAt(t+2)],s=r.lookup[e.charCodeAt(t+3)],d[u++]=a<<2|n>>4,d[u++]=(15&n)<<4|l>>2,d[u++]=(3&l)<<6|63&s;return c}}r.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r.reg=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i,r.reghead=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,/i,r.lookup=null;class a{constructor(){}}class n{constructor(){}}class l{static _parse(e,r=null,a=null){if(l._initData(e),!l._checkglTFVersion(this._glTF.asset))return console.warn("glTF version wrong!"),new t.Sprite3D;l._initBufferData(e.buffers),l._initTextureData(e.images),l._loadMaterials(e.materials),l._loadNodes(e.nodes),l.buildHierarchy(e.nodes),l._loadScenes(e.scenes),l._loadAnimations(e.animations);let n=null!=e.scene?e.scene:0,s=l._glTFScenes[n];return l._clearData(),s}static _initData(e){l._glTF=e,e.buffers&&(l._glTFBuffers.length=e.buffers.length),e.textures&&(l._glTFTextures.length=e.textures.length),e.materials&&(l._glTFMaterials.length=e.materials.length),e.nodes&&(l._glTFNodes.length=e.nodes.length),e.scenes&&(l._glTFScenes.length=e.scenes.length)}static _clearData(){l._glTF=null,l._glTFBuffers.length=0,l._glTFTextures.length=0,l._glTFMaterials.length=0,l._glTFNodes.length=0,l._glTFScenes.length=0,l.NAMEID=0}static _checkglTFVersion(e){return"2.0"===e.version}static RegisterExtra(e,t,r){(l.Extras[e]||(l.Extras[e]={}))[t]=r}static UnRegisterExtra(e,t,r=!0){let a=l.Extras[e]||(l.Extras[e]={});if(r){let e=a[t];e&&e.recover()}delete a[t]}static ExecuteExtras(e,t,r,a){let n=l.Extras[e],s=null;if(n)for(const e in t){let t=n[e];s=t?t.runWith([...a,r]):s}return s=s||r.runWith(a),r.recover(),s}static getNodeRandomName(e){return`${e}_${l.NAMEID++}`}static _initBufferData(e){e&&e.forEach((e,r)=>{l._glTFBuffers[r]=t.Loader.getRes(e.uri)})}static getAccessorComponentsNum(e){switch(e){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 0}}static getAttributeNum(e){switch(e){case"POSITION":case"NORMAL":return 3;case"COLOR":return 4;case"UV":case"UV1":return 2;case"BLENDWEIGHT":case"BLENDINDICES":case"TANGENT":return 4;default:return 0}}static _getTypedArrayConstructor(e){switch(e){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array}}static getBufferwithAccessorIndex(e){let t=l._glTF.accessors[e];if(!t)return null;let r=l._glTF.bufferViews[t.bufferView],a=l._glTFBuffers[r.buffer],n=t.count,s=l.getAccessorComponentsNum(t.type),o=(r.byteOffset||0)+(t.byteOffset||0),i=n*s;return new(l._getTypedArrayConstructor(t.componentType))(a,o,i)}static _initTextureData(e){e&&e.forEach((e,r)=>{e.bufferView?console.warn("glTF Loader: Todo: image bufferView data."):l._glTFTextures[r]=t.Loader.getRes(e.uri)})}static getTextureMipmap(e){return!e||(9729===e.minFilter||9728===e.minFilter)}static getTextureFormat(e){return"image/png"===e.mimeType?1:0}static getTextureFilterMode(e){return e?9728===e.magFilter?0:l.getTextureMipmap(e)&&9987===e.minFilter?2:1:1}static getTextureWrapMode(e){return 33071===e?1:0}static getTextureConstructParams(e,t){let r=[];return r[0]=0,r[1]=0,r[2]=l.getTextureFormat(e),r[3]=l.getTextureMipmap(t),r}static getTexturePropertyParams(e){let t={};return e?(t.filterMode=l.getTextureFilterMode(e),t.wrapModeU=l.getTextureWrapMode(e.wrapS),t.wrapModeV=l.getTextureWrapMode(e.wrapT),t.anisoLevel=16,t):null}static getTexturewithInfo(e){return e.texCoord&&console.warn("glTF Loader: non 0 uv channel unsupported."),l._glTFTextures[e.index]}static _loadMaterials(e){e&&e.forEach((e,t)=>{l._glTFMaterials[t]=l._loadMaterial(e)})}static _loadMaterial(e){if(e.extras){let r=t.Handler.create(this,l._createdefaultMaterial,null,!1);return l.ExecuteExtras("MATERIAL",e.extras,r,[e])}return l._createdefaultMaterial(e)}static _createdefaultMaterial(e){let r=new t.PBRStandardMaterial;switch(r.name=e.name?e.name:"",e.pbrMetallicRoughness&&l.applyPBRMetallicRoughness(e.pbrMetallicRoughness,r),e.normalTexture&&(r.normalTexture=l.getTexturewithInfo(e.normalTexture),null!=e.normalTexture.scale&&(r.normalTextureScale=e.normalTexture.scale)),e.occlusionTexture&&(r.occlusionTexture=l.getTexturewithInfo(e.occlusionTexture),null!=e.occlusionTexture.strength&&(r.occlusionTextureStrength=e.occlusionTexture.strength)),e.emissiveTexture&&(r.emissionTexture=l.getTexturewithInfo(e.emissiveTexture),r.emissionTexture&&(r.enableEmission=!0)),e.emissiveFactor&&(r.emissionColor.fromArray(e.emissiveFactor),r.emissionColor.w=1,r.enableEmission=!0),e.alphaMode||"OPAQUE"){case"OPAQUE":r.renderMode=t.PBRRenderMode.Opaque;break;case"BLEND":r.renderMode=t.PBRRenderMode.Transparent;break;case"MASK":r.renderMode=t.PBRRenderMode.Cutout}return null!=e.alphaCutoff&&(r.alphaTestValue=e.alphaCutoff),e.doubleSided&&(r.cull=t.RenderState.CULL_NONE),r}static applyPBRMetallicRoughness(e,t){e.baseColorFactor&&t.albedoColor.fromArray(e.baseColorFactor),e.baseColorTexture&&(t.albedoTexture=l.getTexturewithInfo(e.baseColorTexture)),null!=e.metallicFactor&&(t.metallic=e.metallicFactor),null!=e.roughnessFactor&&(t.smoothness=1-e.roughnessFactor),e.metallicRoughnessTexture&&(t.metallicGlossTexture=l.getTexturewithInfo(e.metallicRoughnessTexture))}static pickMeshMaterials(e){let r=[];return e.primitives.forEach(e=>{if(null!=e.material){let t=l._glTFMaterials[e.material];r.push(t)}else{let a=new t.PBRStandardMaterial;r.push(a),l._glTFMaterials.push(a),e.material=l._glTFMaterials.indexOf(a)}}),r}static _loadScenes(e){e&&e.forEach((e,t)=>{l._glTFScenes[t]=l._loadScene(e)})}static _loadScene(e){return l._createSceneNode(e)}static _createSceneNode(e){let r=new t.Sprite3D(e.name||"glTF_Scene_node");return e.nodes.forEach(e=>{let t=l._glTFNodes[e];r.addChild(t)}),r}static applyTransform(e,t){if(e.matrix){let r=t.transform.localMatrix;r.elements.set(e.matrix),t.transform.localMatrix=r}else{let r=t.transform.localPosition,a=t.transform.localRotation,n=t.transform.localScale;e.translation&&r.fromArray(e.translation),e.rotation&&a.fromArray(e.rotation),e.scale&&n.fromArray(e.scale),t.transform.localPosition=r,t.transform.localRotation=a,t.transform.localScale=n}}static buildHierarchy(e){e.forEach((e,t)=>{let r=l._glTFNodes[t];e.children&&e.children.forEach(e=>{let t=l._glTFNodes[e];r.addChild(t)})}),e.forEach((e,r)=>{let a=l._glTFNodes[r];a instanceof t.SkinnedMeshSprite3D&&l.fixSkinnedSprite(e,a)})}static _loadNodes(e){e&&(e.forEach((e,t)=>{e.name=e.name||l.getNodeRandomName("node")}),e.forEach((e,t)=>{l._glTFNodes[t]=l._loadNode(e)}))}static _loadNode(e){return l._createSprite3D(e)}static _createSprite3D(e){if(e.name=e.name,null!=e.skin){let t=l._createSkinnedMeshSprite3D(e);return l.applyTransform(e,t),t}if(null!=e.mesh){let t=l._createMeshSprite3D(e);return l.applyTransform(e,t),t}{let r=new t.Sprite3D(e.name);return l.applyTransform(e,r),r}}static _createMeshSprite3D(e){let r=l._glTF.meshes[e.mesh],a=l._loadMesh(r),n=l.pickMeshMaterials(r),s=new t.MeshSprite3D(a,e.name);return s.meshRenderer.sharedMaterials=n,s}static _createSkinnedMeshSprite3D(e){let r=l._glTF.meshes[e.mesh],a=l._glTF.skins[e.skin],n=l._loadMesh(r,a),s=l.pickMeshMaterials(r),o=new t.SkinnedMeshSprite3D(n,e.name);return o.skinnedMeshRenderer.sharedMaterials=s,o}static getArrributeBuffer(e,t,r,a){let n=l.getBufferwithAccessorIndex(e);if(!n)return null;a.push(t);let s=n;return r.set(t,s),s}static getIndexBuffer(e,t){let r=l.getBufferwithAccessorIndex(e);if(r)return new Uint32Array(r).reverse();{let e=new Uint32Array(t);for(let r=0;r<t;r++)e[r]=r;return e}}static parseMeshwithSubMeshData(e,r){let a=0,n=0,s=void 0;e.forEach(e=>{a+=e.vertexCount,n+=e.indices.length,s=s||e.vertexDecler});let o,i=t.VertexMesh.getVertexDeclaration(s,!1),u=i.vertexStride/4,c=new Float32Array(u*a),d=t.IndexFormat.UInt32;a<65536&&(o=new Uint16Array(n),d=t.IndexFormat.UInt16),l.fillMeshBuffers(e,c,o,u),l.generatMesh(c,o,i,d,e,r)}static fillMeshBuffers(e,t,r,a){let n=0,l=0,s=0;e.forEach(e=>{let o=n,i=e.vertexCount,u=e.indices;for(let e=0;e<u.length;e++)r[o+e]=u[e]+l;n+=u.length,l+=i;const fillAttributeBuffer=(e,r,n=0)=>{let l=s+r;for(let r=0;r<i;r++)for(let s=0;s<n;s++)t[l+r*a+s]=e[r*n+s]};let c=0,d=e.attributeMap,f=d.get("POSITION");f&&(fillAttributeBuffer(f,c,3),c+=3);let g=d.get("NORMAL");g&&(fillAttributeBuffer(g,c,3),c+=3);let h=d.get("COLOR");h&&(fillAttributeBuffer(h,c,4),c+=4);let _=d.get("UV");_&&(fillAttributeBuffer(_,c,2),c+=2);let T=d.get("UV1");T&&(fillAttributeBuffer(T,c,2),c+=2);let m=d.get("BLENDWEIGHT");m&&(fillAttributeBuffer(m,c,4),c+=4);let p=d.get("BLENDINDICES");if(p){let e=new Uint8Array(p);fillAttributeBuffer(new Float32Array(e.buffer),c,1),c+=1}let x=d.get("TANGENT");x&&(fillAttributeBuffer(x,c,4),c+=4),s+=i*a})}static splitSubMeshByBonesCount(e,t,r,a,n){let s=l.maxSubBoneCount,o=0,i=new Set,u=e.get("BLENDINDICES"),c=u.length/4,d=new Float32Array(u.length),f=new Array(c).fill(!1);for(let e=0,l=t.length;e<l;e+=3){let c=new Set;for(let r=e;r<e+3;r++){let e=4*t[r];for(let t=0;t<4;t++)c.add(u[e+t])}let d=new Set([...i,...c]);if(d.size>s){let t=e-o;a.push(o),n.push(t);let l=Array.from(i);r.push(new Uint16Array(l)),o=e,i=new Set(c)}else i=d;if(e==l-3){let t=e-o+3;a.push(o),n.push(t),o=e;let l=Array.from(i);r.push(new Uint16Array(l))}}let g=r.length,h=new Map;e.forEach((e,t)=>{let r=new Array;h.set(t,r)});let _=c-1;for(let s=0;s<g;s++){let o=a[s],i=n[s],g=r[s],T=new Array(c).fill(!1),m=new Map;for(let r=0;r<i;r++){let a=t[r+o],n=4*a;for(let e=n;e<n+4;e++){let t=u[e],r=g.indexOf(t);r=-1==r?0:r,f[a]&&!T[a]?h.get("BLENDINDICES").push(r):f[a]&&T[a]||(d[e]=r)}f[a]||T[a]?!f[a]&&T[a]?t[r+o]=m.get(a):f[a]&&!T[a]?(T[a]=!0,_++,m.set(a,_),t[r+o]=_,h.forEach((t,r)=>{let n=l.getAttributeNum(r),s=e.get(r);if("BLENDINDICES"!==r)for(let e=0;e<n;e++)t.push(s[e+a*n])})):f[a]&&T[a]&&(t[r+o]=m.get(a)):(T[a]=!0,m.set(a,a))}T.forEach((e,t)=>{f[t]=e||f[t]})}h.forEach((t,r)=>{let a=e.get(r);"BLENDINDICES"==r&&(a=d);let n=a.length+t.length,l=new Float32Array(n);l.set(a,0),l.set(t,a.length),e.set(r,l)}),u=null}static generatMesh(e,r,a,n,l,s){let o=t.LayaGL.instance,i=new t.VertexBuffer3D(e.byteLength,o.STATIC_DRAW,!0);i.vertexDeclaration=a,i.setData(e.buffer);let u=new t.IndexBuffer3D(n,r.length,o.STATIC_DRAW,!0);u.setData(r),s._indexFormat=n,s._indexBuffer=u,s._vertexBuffer=i,s._setBuffer(i,u),s._vertexCount=i._byteLength/a.vertexStride;let c=0,d=l.length,f=new Array(d);for(let e=0;e<d;e++){let r=l[e],a=new t.SubMesh(s);f[e]=a,a._vertexBuffer=i,a._indexBuffer=u;let o=c;c+=r.indices.length;let d=r.indices.length;a._setIndexRange(o,d,n),a._boneIndicesList=r.boneIndicesList,a._subIndexBufferStart=r.subIndexStartArray,a._subIndexBufferCount=r.subIndexCountArray;for(let e=0;e<a._subIndexBufferStart.length;e++)a._subIndexBufferStart[e]+=o}s._setSubMeshes(f),s.calculateBounds();let g=i._byteLength+u._byteLength;s._setCPUMemory(g),s._setGPUMemory(g)}static applyglTFSkinData(e,r,a){if(!a)return;let n=a.joints,s=new Float32Array(l.getBufferwithAccessorIndex(a.inverseBindMatrices)),o=n.length,i=e._boneNames=[];n.forEach(e=>{let t=l._glTF.nodes[e];i.push(t.name)}),e._inverseBindPoses=[],e._inverseBindPosesBuffer=s.buffer,e._setInstanceBuffer(t.Mesh.MESH_INSTANCEBUFFER_TYPE_NORMAL);for(let r=0;r<o;r++){let a=16*r,n=s.slice(a,a+16);e._inverseBindPoses[r]=new t.Matrix4x4(n[0],n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11],n[12],n[13],n[14],n[15],n)}let u=r.length,c=e._skinnedMatrixCaches;c.length=e._inverseBindPoses.length;for(let r=0;r<u;r++){let a=e.getSubMesh(r),n=a._subIndexBufferStart.length;for(let e=0;e<n;e++){let n=a._boneIndicesList[e];for(let a=0;a<n.length;a++){let l=n[a];c[l]||(c[l]=new t.skinnedMatrixCache(r,e,a))}}}for(let e=0;e<c.length;e++)c[e]||(c[e]=new t.skinnedMatrixCache(0,0,0))}static _loadMesh(e,r){if(e.extras){let a=t.Handler.create(this,l._createMesh,null,!1);return l.ExecuteExtras("MESH",e.extras,a,[e,r])}return l._createMesh(e,r)}static _createMesh(e,r){let n=new t.Mesh,s=e.primitives,o=e.weights,i=r?r.joints.length:0,u=[];return s.forEach(e=>{let t=e.mode;null==t&&(t=4),4!=t&&console.warn("glTF Loader: only support gl.TRIANGLES.");let n=[],s=new Map,c=e.attributes,d=l.getArrributeBuffer(c.POSITION,"POSITION",s,n),f=l.getArrributeBuffer(c.NORMAL,"NORMAL",s,n),g=(l.getArrributeBuffer(c.COLOR_0,"COLOR",s,n),l.getArrributeBuffer(c.TEXCOORD_0,"UV",s,n),l.getArrributeBuffer(c.TEXCOORD_1,"UV1",s,n),l.getArrributeBuffer(c.WEIGHTS_0,"BLENDWEIGHT",s,n),l.getArrributeBuffer(c.JOINTS_0,"BLENDINDICES",s,n),l.getArrributeBuffer(c.TANGENT,"TANGENT",s,n)),h=e.targets;h&&h.forEach((e,t)=>{let r=o[t],a=l.getBufferwithAccessorIndex(e.POSITION),n=l.getBufferwithAccessorIndex(e.NORMAL),s=l.getBufferwithAccessorIndex(e.TANGENT);a&&a.forEach((e,t)=>{d[t]+=e*r}),n&&n.forEach((e,t)=>{f[t]+=e*r}),s&&s.forEach((e,t)=>{g[t]+=e*r})});let _=d.length/3,T=l.getIndexBuffer(e.indices,_),m=new Array,p=[],x=[];if(r)if(i>l.maxSubBoneCount)l.splitSubMeshByBonesCount(s,T,m,p,x),_=s.get("POSITION").length/3;else{p[0]=0,x[0]=T.length,m[0]=new Uint16Array(i);for(let e=0;e<i;e++)m[0][e]=e}else p[0]=0,x[0]=T.length;let A=n.toString(),M=new a;u.push(M),M.attributeMap=s,M.indices=T,M.vertexCount=_,M.vertexDecler=A,M.boneIndicesList=m,M.subIndexStartArray=p,M.subIndexCountArray=x}),l.parseMeshwithSubMeshData(u,n),l.applyglTFSkinData(n,u,r),n}static calSkinnedSpriteLocalBounds(e){let r=e.skinnedMeshRenderer,a=e.meshFilter.sharedMesh,n=r.rootBone.transform.worldMatrix,l=new t.Matrix4x4;n.invert(l);let s=a.getIndices(),o=[],i=[],u=[];a.getPositions(o),a.getBoneIndices(i),a.getBoneWeights(u);let c=[];a._subMeshes.forEach((e,r)=>{e._boneIndicesList.forEach((r,a)=>{let n=e._subIndexBufferStart[a],l=e._subIndexBufferCount[a]+n;for(let e=n;e<l;e++){let a=s[e],n=i[a],l=r[n.x],o=r[n.y],u=r[n.z],d=r[n.w];c[a]=new t.Vector4(l,o,u,d)}})});let d=a._inverseBindPoses,f=r.bones,g=[],h=new t.Matrix4x4;f.forEach((e,r)=>{g[r]=new t.Matrix4x4,t.Matrix4x4.multiply(l,e.transform.worldMatrix,h),t.Matrix4x4.multiply(h,d[r],g[r])});let _=new t.Matrix4x4,T=new t.Vector3,m=new t.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),p=new t.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);o.forEach((e,r)=>{let a=c[r],n=u[r];for(let e=0;e<16;e++)_.elements[e]=g[a.x].elements[e]*n.x,_.elements[e]+=g[a.y].elements[e]*n.y,_.elements[e]+=g[a.z].elements[e]*n.z,_.elements[e]+=g[a.w].elements[e]*n.w;t.Vector3.transformV3ToV3(e,_,T),t.Vector3.min(m,T,m),t.Vector3.max(p,T,p)}),o=null,i=u=c=null,s=null,g=null,r.localBounds.setMin(m),r.localBounds.setMax(p)}static fixSkinnedSprite(e,t){let r=l._glTF.skins[e.skin],a=t.skinnedMeshRenderer;r.joints.forEach(e=>{let t=l._glTFNodes[e];a.bones.push(t)}),null==r.skeleton&&(r.skeleton=r.joints[0]),a.rootBone=l._glTFNodes[r.skeleton],l.calSkinnedSpriteLocalBounds(t)}static getAnimationRoot(e){const isContainNode=(e,t)=>{if(!e)return!1;if(-1==e.indexOf(t))for(let r=0;r<e.length;r++){let a=l._glTF.nodes[e[r]];if(isContainNode(a.children,t))return!0}return!0};let t=e[0].target.node;for(let e=0;e<l._glTF.scenes.length;e++){let r=l._glTF.scenes[e];if(isContainNode(r.nodes,t))return l._glTFScenes[e]}return null}static getAnimationPath(e,t){let r=[];if(e==t)return r;let a=t;for(;a.parent!=e;)a=a.parent,r.push(a.name);return r=r.reverse(),r.push(t.name),r}static _loadAnimations(e){e&&e.forEach((e,t)=>{l._loadAnimation(e)})}static _loadAnimation(e){return l._createAnimator(e)}static _createAnimator(e){let r=new t.Animator,a=e.channels,s=e.samplers,o=l.getAnimationRoot(a);if(!o)return r;o.addComponentIntance(r);let i=0,u=new Array(a.length);a.forEach((e,t)=>{let r=e.target,a=s[e.sampler],c=u[t]=new n,d=l._glTFNodes[r.node],f=l.getBufferwithAccessorIndex(a.input),g=l.getBufferwithAccessorIndex(a.output);switch(c.timeArray=new Float32Array(f),c.valueArray=new Float32Array(g),c.paths=l.getAnimationPath(o,d),c.propertyOwner="transform",c.propertyLength=1,c.propertise=[],r.path){case"translation":c.propertise.push("localPosition"),c.type=1;break;case"rotation":c.propertise.push("localRotation"),c.type=2;break;case"scale":c.propertise.push("localScale"),c.type=3}c.duration=c.timeArray[c.timeArray.length-1],i=Math.max(i,c.duration)});let c=e.name?e.name:"Aniamtor",d=new t.AnimatorControllerLayer(c),f=new t.AnimationClip;f.name="clip name",f._duration=i,f.islooping=!0,f._frameRate=30;let g=u.length,h=f._nodes;h.count=g;let _=f._nodesMap={},T=f._nodesDic={};for(let e=0;e<g;e++){let r=new t.KeyframeNode,a=u[e];h.setNodeByIndex(e,r),r._indexInList=e;let n=r.type=a.type,l=a.paths.length;r._setOwnerPathCount(l);let s=a.paths;for(let e=0;e<l;e++)r._setOwnerPathByIndex(e,s[e]);let o=r._joinOwnerPath("/"),i=_[o];i||(_[o]=i=[]),i.push(r),r.propertyOwner=a.propertyOwner;let c=a.propertyLength;r._setPropertyCount(c);for(let e=0;e<c;e++)r._setPropertyByIndex(e,a.propertise[e]);let d=o+"."+r.propertyOwner+"."+r._joinProperty(".");T[d]=d,r.fullPath=d;let f=a.timeArray.length;for(let e=0;e<f;e++)switch(n){case 0:break;case 1:case 3:case 4:let n=new t.Vector3Keyframe;r._setKeyframeByIndex(e,n);n.time=a.timeArray[e];let l=n.inTangent,s=n.outTangent,o=n.value;l.setValue(0,0,0),s.setValue(0,0,0),o.setValue(a.valueArray[3*e],a.valueArray[3*e+1],a.valueArray[3*e+2]);break;case 2:let i=new t.QuaternionKeyframe;r._setKeyframeByIndex(e,i);i.time=a.timeArray[e];let u=i.inTangent,c=i.outTangent,d=i.value;u.setValue(0,0,0,0),c.setValue(0,0,0,0),d.x=a.valueArray[4*e],d.y=a.valueArray[4*e+1],d.z=a.valueArray[4*e+2],d.w=a.valueArray[4*e+3]}}let m=new t.AnimatorState;return m.name="state name",m.clip=f,d.addState(m),d.defaultState=m,d.playOnWake=!0,r.addControllerLayer(d),d.defaultWeight=1,r}}l.NAMEID=0,l.maxSubBoneCount=24,l.Extensions={},l.Extras={},l._glTFBuffers=[],l._glTFTextures=[],l._glTFMaterials=[],l._glTFNodes=[],l._glTFScenes=[];class s{static init(){t.LoaderManager.createMap.gltf=[s.GLTF,l._parse];let e=t.Loader.parserMap;e[s.GLTF]=s._loadglTF,e[s.GLTFBASE64TEX]=s._loadBase64Texture,s._innerBufferLoaderManager.on(t.Event.ERROR,null,s._eventLoadManagerError),s._innerTextureLoaderManager.on(t.Event.ERROR,null,s._eventLoadManagerError)}static _loadglTF(e){e._originType=e.type,e.on(t.Event.LOADED,null,s._onglTFLoaded,[e]),e.load(e.url,t.Loader.JSON,!1,null,!0)}static _loadBase64Texture(e){let r=e.url;e.on(t.Event.LOADED,null,(function(r){e._cache=e._createCache;let a=t.Texture2D._parse(r,e._propertyParams,e._constructParams);s._endLoad(e,a)})),e.load(r,"nativeimage",!1,null,!0)}static formatRelativePath(e,t){let r;if(r=e+t,"."===t.charAt(0)){let e=r.split("/");for(let t=0,r=e.length;t<r;t++)if(".."==e[t]){let r=t-1;r>0&&".."!==e[r]&&(e.splice(r,2),t-=2)}r=e.join("/")}return r}static _addglTFInnerUrls(e,t,r,a,n,l,o=null,i=null){let u=s.formatRelativePath(a,n);return r&&(u+=r),e.push({url:u,type:l,constructParams:o,propertyParams:i}),t&&t.push(u),u}static _getglTFInnerUrls(e,r,a,n,o,i){e.buffers&&e.buffers.forEach(e=>{if(t.glTFBase64Tool.isBase64String(e.uri)){let r=t.glTFBase64Tool.decode(e.uri.replace(t.glTFBase64Tool.reghead,""));t.Loader.cacheRes(e.uri,r)}else e.uri=s._addglTFInnerUrls(r,null,o,i,e.uri,t.Loader.BUFFER)}),e.textures&&e.textures.forEach(r=>{let u=e.images[r.source],c=e.samplers?e.samplers[r.sampler]:void 0,d=l.getTextureConstructParams(u,c),f=l.getTexturePropertyParams(c);u.bufferView||(t.glTFBase64Tool.isBase64String(u.uri)?u.uri=s._addglTFInnerUrls(a,n,o,"",u.uri,s.GLTFBASE64TEX,d,f):u.uri=s._addglTFInnerUrls(a,n,o,i,u.uri,t.Loader.TEXTURE2D,d,f))})}static _onglTFLoaded(e,r){let a=e.url,n=t.Utils3D.getURLVerion(a),l=t.URL.getPath(a),o=[],i=[],u=[];s._getglTFInnerUrls(r,o,i,u,n,l);let c=o.length+i.length,d=c+1,f=1/d;s._onProcessChange(e,0,f,1);let g=c/d;if(o.length>0){let a=t.Handler.create(null,s._onProcessChange,[e,f,g],!1);s._innerBufferLoaderManager._create(o,!1,t.Handler.create(null,s._onglTFBufferResourceLoaded,[e,a,r,u,i,f+g*o.length,g]),a,null,null,null,1,!0)}else s._onglTFBufferResourceLoaded(e,null,r,u,i,f,g)}static _onglTFBufferResourceLoaded(e,r,a,n,l,o,i){if(r&&r.recover(),l.length>0){let u=t.Handler.create(null,s._onProcessChange,[e,o,i],!1);s._innerTextureLoaderManager._create(l,!1,t.Handler.create(null,s._onglTFTextureResourceLoaded,[e,u,a,n]),r,null,null,null,1,!0)}else s._onglTFTextureResourceLoaded(e,r,a,n)}static _onglTFTextureResourceLoaded(e,t,r,a){t&&t.recover(),e._cache=e._createCache;let n=l._parse(r,e._propertyParams,e._constructParams);s._endLoad(e,n,a)}static _eventLoadManagerError(e){t.Laya.loader.event(t.Event.ERROR,e)}static _onProcessChange(e,r,a,n){(n=r+n*a)<1&&e.event(t.Event.PROGRESS,2*n/3+1/3)}static _endLoad(e,r=null,a=null){if(a)for(let e=0;e<a.length;e++){let r=t.Loader.getRes(a[e]);r&&r._removeReference()}e.endLoad(r)}}s.GLTF="GLTF",s.GLTFBASE64TEX="GLTFBASE64TEX",s._innerBufferLoaderManager=new t.LoaderManager,s._innerTextureLoaderManager=new t.LoaderManager,e.glTFBase64Tool=r,e.glTFLoader=s,e.glTFUtils=l}(window.Laya=window.Laya||{},Laya);